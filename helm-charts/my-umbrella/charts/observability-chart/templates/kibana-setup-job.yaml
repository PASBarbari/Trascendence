{{- if (index .Values "eck-kibana").enabled }}
---
# Job to import Kibana dashboards and index patterns
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "observability-chart.fullname" . }}-kibana-setup
  namespace: {{ .Values.global.namespace.name }}
  labels:
    {{- include "observability-chart.labels" . | nindent 4 }}
    app.kubernetes.io/component: kibana-setup
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "observability-chart.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: kibana-setup
    spec:
      restartPolicy: OnFailure
      containers:
      - name: kibana-setup
        image: curlimages/curl:8.1.2
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Waiting for Kibana to be ready..."
          
          # Wait for Kibana to be available
          until curl -s -k "https://{{ index .Values "eck-kibana" "fullnameOverride" }}-kb-http.{{ .Values.global.namespace.name }}.svc.cluster.local:5601/api/status" \
            -u "elastic:${ELASTICSEARCH_PASSWORD}" \
            -H "Content-Type: application/json" | grep -q '"overall":{"level":"available"'; do
            echo "Kibana not ready yet, waiting..."
            sleep 10
          done
          
          echo "Kibana is ready, setting up index patterns and dashboards..."
          
          # Create index pattern for all logs
          curl -s -k -X POST "https://{{ index .Values "eck-kibana" "fullnameOverride" }}-kb-http.{{ .Values.global.namespace.name }}.svc.cluster.local:5601/api/saved_objects/index-pattern/logstash-*" \
            -u "elastic:${ELASTICSEARCH_PASSWORD}" \
            -H "Content-Type: application/json" \
            -H "kbn-xsrf: true" \
            -d '{
              "attributes": {
                "title": "logstash-*",
                "timeFieldName": "@timestamp"
              }
            }' || echo "Index pattern may already exist"
          
          # Create namespace-specific index patterns
          for namespace in login chat task-user pong notifications; do
            curl -s -k -X POST "https://{{ index .Values "eck-kibana" "fullnameOverride" }}-kb-http.{{ .Values.global.namespace.name }}.svc.cluster.local:5601/api/saved_objects/index-pattern/logstash-${namespace}-*" \
              -u "elastic:${ELASTICSEARCH_PASSWORD}" \
              -H "Content-Type: application/json" \
              -H "kbn-xsrf: true" \
              -d "{
                \"attributes\": {
                  \"title\": \"logstash-${namespace}-*\",
                  \"timeFieldName\": \"@timestamp\"
                }
              }" || echo "Index pattern for ${namespace} may already exist"
          done
          
          # Set as default index pattern
          curl -s -k -X POST "https://{{ index .Values "eck-kibana" "fullnameOverride" }}-kb-http.{{ .Values.global.namespace.name }}.svc.cluster.local:5601/api/kibana/settings" \
            -u "elastic:${ELASTICSEARCH_PASSWORD}" \
            -H "Content-Type: application/json" \
            -H "kbn-xsrf: true" \
            -d '{
              "changes": {
                "defaultIndex": "logstash-*"
              }
            }' || echo "Default index already set"
          
          echo "âœ… Kibana setup completed successfully!"
          
        env:
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: eck-elasticsearch-es-elastic-user
              key: elastic
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 128Mi
{{- end }}
